# llama.cpp/example/batched-bench

`llama.cpp`의 배치 디코딩 성능을 벤치마크합니다.

## 사용법

2가지 운영 모드가 있습니다.

- `prompt not shared` - 각 배치는 크기가 `PP`인 별도의 프롬프트를 사용합니다. (즉, `N_KV = B*(PP + TG)`)
- `prompt is shared` - 모든 배치에 의해 공용으로 사용되는 크기가 `PP`인 프롬프트가 있습니다. (즉, `N_KV = PP + B*TG`)

```bash
./llama-batched-bench -m model.gguf -c 2048 -b 2048 -ub 512 -npp 128,256,512 -ntg 128,256 -npl 1,2,4,8,16,32 [-pps]

# LLaMA 7B, F16, N_KV_MAX = 16384 (8GB), prompt not shared
./llama-batched-bench -m ./models/llama-7b/ggml-model-f16.gguf -c 16384 -b 2048 -ub 512 -ngl 99

# LLaMA 7B, Q8_0, N_KV_MAX = 16384 (8GB), prompt is shared
./llama-batched-bench -m ./models/llama-7b/ggml-model-q8_0.gguf -c 16384 -b 2048 -ub 512 -ngl 99 -pps

# custom set of batches
./llama-batched-bench -m ./models/llama-7b/ggml-model-q8_0.gguf -c 2048 -b 512 -ub 512 -ngl 999 -npp 128,256,512 -ntg 128,256 -npl 1,2,4,8,16,32
```

## 샘플 결과

- `PP` - 배치당 프롬프트 토큰 수
- `TG` - 배치당 생성 토큰 수
- `B` - 배치 수
- `N_KV` - 필요한 KV 캐시 크기
- `T_PP` - 프롬프트 처리 시간 (즉, 첫 번째 토큰까지의 시간)
- `S_PP` - 프롬프트 처리 속도 (`(B*PP)/T_PP` 또는 `PP/T_PP`)
- `T_TG` - 모든 배치를 생성하는 데 걸린 시간
- `S_TG` - 텍스트 생성 속도 (`(B*TG)/T_TG`)
- `T` - 총 시간
- `S` - 총 속도 (즉, 모든 토큰 / 총 시간)

|    PP |     TG |    B |   N_KV |   T_PP s | S_PP t/s |   T_TG s | S_TG t/s |      T s |    S t/s |
|-------|--------|------|--------|----------|----------|----------|----------|----------|----------|
|   128 |    128 |    1 |    256 |    0.108 |  1186.64 |    3.079 |    41.57 |    3.187 |    80.32 |
|   128 |    128 |    2 |    512 |    0.198 |  1295.19 |    5.029 |    50.90 |    5.227 |    97.95 |
|   128 |    128 |    4 |   1024 |    0.373 |  1373.96 |    6.878 |    74.44 |    7.251 |   141.23 |
|   128 |    128 |    8 |   2048 |    0.751 |  1363.27 |    7.344 |   139.43 |    8.095 |   252.99 |
|   128 |    128 |   16 |   4096 |    1.570 |  1304.68 |    8.455 |   242.23 |   10.024 |   408.60 |
|   128 |    128 |   32 |   8192 |    3.408 |  1201.73 |    8.801 |   465.40 |   12.209 |   670.96 |
|   128 |    256 |    1 |    384 |    0.107 |  1196.70 |    6.329 |    40.45 |    6.436 |    59.67 |
|   128 |    256 |    2 |    768 |    0.194 |  1317.45 |   10.239 |    50.00 |   10.433 |    73.61 |
|   128 |    256 |    4 |   1536 |    0.366 |  1399.03 |   13.960 |    73.35 |   14.326 |   107.22 |
|   128 |    256 |    8 |   3072 |    0.751 |  1363.92 |   15.110 |   135.54 |   15.861 |   193.69 |
|   128 |    256 |   16 |   6144 |    1.569 |  1304.93 |   18.073 |   226.64 |   19.642 |   312.80 |
|   128 |    256 |   32 |  12288 |    3.409 |  1201.35 |   19.223 |   426.15 |   22.633 |   542.93 |
